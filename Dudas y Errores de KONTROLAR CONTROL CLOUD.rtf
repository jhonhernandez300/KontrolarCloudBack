{\rtf1\ansi\ansicpg1252\deff0\nouicompat\deflang3082{\fonttbl{\f0\fnil\fcharset0 Calibri;}{\f1\fnil Cascadia Mono;}{\f2\fnil\fcharset0 Cascadia Mono;}}
{\colortbl ;\red0\green0\blue0;}
{\*\generator Riched20 10.0.22621}\viewkind4\uc1 
\pard\sa200\sl276\slmult1\qc\f0\fs36\lang10 Dudas y Errores de KONTROLAR CONTROL CLOUD\fs22\par

\pard\sl240\slmult1\par
///////////////////////////////////\par
\par
\b A veces es necesario para que EF sepa como son las relaciones\b0\par
\cf1\fs19 protected override void OnModelCreating(ModelBuilder modelBuilder)\par
\{\par
    modelBuilder.Entity<UserCompany>()\par
        .HasOne(uc => uc.User)\par
        .WithMany(u => u.UserCompanies)\par
        .HasForeignKey(uc => uc.IdUser);\par
\par
    modelBuilder.Entity<UserCompany>()\par
        .HasOne(uc => uc.Company)\par
        .WithMany(c => c.UserCompanies)\par
        .HasForeignKey(uc => uc.IdCompany);\par
\par
    base.OnModelCreating(modelBuilder);\par
\}\par
\par
\lang9226 /////////////////////////////\par
\par
\b Agregar un registro usando la tabla que guarda el \'faltimo id\par
\b0 [HttpPost("Add")]\par
public IActionResult Add([FromBody] User user)\par
\{\par
    try\par
    \{\par
        if (user == null)\par
        \{\par
            return BadRequest(Json("Datos inv\'e1lidos del user"));\par
        \}\par
\par
        // Consultar el \'faltimo ID usado para la tabla User\par
        var lastIdRecord = _unitOfWork.LastIds.GetBigger("MT_Users");\par
\par
        if (lastIdRecord == null)\par
        \{\par
            return StatusCode(500, Json("No se encontr\'f3 un registro de Last (id) para la tabla User"));\par
        \}\par
\par
        int newUserId = lastIdRecord.Last + 1;\par
        user.IdUser = newUserId;\par
\par
        var nuevoUser = _unitOfWork.Users.Add(user);\par
        _unitOfWork.Complete();\par
\par
        // Actualizar el modelo LastId con el nuevo ID\par
        lastIdRecord.Last = newUserId;\par
        _unitOfWork.LastIds.Update(lastIdRecord);\par
        _unitOfWork.Complete();\par
\par
        return Ok(Json(nuevoUser));\par
    \}\par
    catch (Exception ex)\par
    \{\par
        return StatusCode(500, Json($"Error interno del servidor: \{ex.Message\}"));\par
  \}\par
\}           \par
\par
/////////////////////////////\par
\par
\b Al preguntarle a ChatGPT \b0 incluir Program.cs para que mire la inyecci\'f3n de dependencias\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\cf0\b\fs22\lang10 C\'f3mo crear un acci\'f3n en el controlador que use un SP\par
\cf1\b0\fs19 public interface ICompanyRepository : IBaseRepository<Company>\par
\{\par
    Task<List<Company>> GetCompaniesByDocumentNumber(string documentNumber);\par
\}\par
\par
 public interface IUnitOfWork : IDisposable\par
 \{\par
     //IBaseRepository<Company> Companies \{ get; \}\par
     ICompanyRepository Companies \{ get; \}\par
     IBaseRepository<User> Users \{ get; \}\par
        \par
     IUserCompanyRepository UsersCompanies \{ get; \}\par
     ILastIdRepository LastIds \{ get; \}\par
\par
     int Complete();\par
 \}\par
\par
public class CompanyRepository : BaseRepository<Company>, ICompanyRepository\par
\{\par
    private readonly ApplicationDbContext _context;\par
\par
    public CompanyRepository(ApplicationDbContext context) : base(context)\par
    \{\par
        _context = context;\par
    \}\par
\par
    //Este m\'e9todo es distinto por que usa un SP en lugar de EF\par
    public async Task<List<Company>> GetCompaniesByDocumentNumber(string documentNumber)\par
    \{\par
        var companies = new List<Company>();\par
\par
        var conn = _context.Database.GetDbConnection();\par
        try\par
        \{\par
            await conn.OpenAsync();\par
\par
            using (var command = conn.CreateCommand())\par
            \{\par
                command.CommandText = "GetCompaniesByDocumentNumber";\par
                command.CommandType = CommandType.StoredProcedure;\par
\par
                var param = command.CreateParameter();\par
                param.ParameterName = "@DocumentNumber";\par
                param.Value = documentNumber;\par
                command.Parameters.Add(param);\par
\par
                using (var reader = await command.ExecuteReaderAsync())\par
                \{\par
                    while (await reader.ReadAsync())\par
                    \{\par
                        companies.Add(new Company\par
                        \{\par
                            IdCompany = reader.GetInt32(0),\par
                            CompanyName = reader.GetString(1),\par
                            DB = reader.GetString(2),\par
                            UserName = reader.GetString(3),\par
                            CompanyPassword = reader.GetString(4),\par
                            LicenseValidDate = reader.GetDateTime(5),\par
                            ConectionsSimultaneousNumber = reader.GetInt32(6)\par
                        \});\par
                    \}\par
                \}\par
            \}\par
        \}\par
        finally\par
        \{\par
            await conn.CloseAsync();\par
        \}\par
\par
        return companies;\par
    \}\par
\}\par
\par
public class UnitOfWork : IUnitOfWork\par
\{\par
    private readonly ApplicationDbContext _context;\par
\par
    public UnitOfWork(ApplicationDbContext context,\par
                      //IBaseRepository<Company> companies,\par
                      ICompanyRepository companies,\par
                      IBaseRepository<User> users,\par
                      IUserCompanyRepository usersCompanies,\par
                      ILastIdRepository lastIds)\par
    \{\par
        _context = context;\par
        Companies = companies;\par
        Users = users;\par
        UsersCompanies = usersCompanies;\par
        LastIds = lastIds;\par
    \}\par
\par
    //public IBaseRepository<Company> Companies \{ get; private set; \}\par
    public ICompanyRepository Companies \{ get; private set; \}\par
    public IBaseRepository<User> Users \{ get; private set; \}        \par
    public IUserCompanyRepository UsersCompanies \{ get; private set; \}\par
    public ILastIdRepository LastIds \{ get; private set; \}\par
\par
    public int Complete()\par
    \{\par
        return _context.SaveChanges();\par
    \}\par
\par
    public void Dispose()\par
    \{\par
        _context.Dispose();\par
    \}\par
\}\par
\par
[HttpGet("GetCompaniesByDocumentNumber/\{documentNumber\}")]\par
public async Task<IActionResult> GetCompaniesByDocumentNumber(string documentNumber)\par
\{\par
    try\par
    \{\par
        var companies = await _unitOfWork.Companies.GetCompaniesByDocumentNumber(documentNumber);\par
\par
        if (companies == null || !companies.Any())\par
        \{\par
            return NotFound("No se encontraron compa\'f1\'edas para el n\'famero de documento proporcionado.");\par
        \}\par
\par
        return Ok(companies);\par
    \}\par
    catch (Exception ex)\par
    \{\par
        return StatusCode(500, $"Error interno del servidor: \{ex.Message\}");\par
    \}\par
\}\par
\par
//builder.Services.AddTransient<IUnitOfWork, UnitOfWork>();\par
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();\par
builder.Services.AddScoped<ICompanyRepository, CompanyRepository>();\par
builder.Services.AddScoped<IBaseRepository<Company>, BaseRepository<Company>>();\par
builder.Services.AddScoped<IBaseRepository<User>, BaseRepository<User>>();\par
//builder.Services.AddScoped<IBaseRepository<UserCompany>, BaseRepository<UserCompany>>();\par
builder.Services.AddScoped<IUserCompanyRepository, UserCompanyRepository>();\par
builder.Services.AddScoped<ILastIdRepository, LastIdRepository>();\cf0\fs22\par
\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\b Encriptar - desencriptar\b0\par
\f1 using System.Security.Cryptography;\par
\par
namespace Core.Utils\par
\{\par
    public static class CryptoHelper\par
    \{\par
        private static readonly string Key = "1234567890123456"; // 16 bytes\par
        private static readonly string Iv = "1234567890123456"; // 16 bytes\par
\par
        public static string Decrypt(string encryptedData)\par
        \{\par
            byte[] cipherBytes = Convert.FromBase64String(encryptedData);\par
\par
            using (Aes aesAlg = Aes.Create())\par
            \{\par
                aesAlg.Key = Encoding.UTF8.GetBytes(Key);\par
                aesAlg.IV = Encoding.UTF8.GetBytes(Iv);\par
                aesAlg.Mode = CipherMode.CBC;\par
                aesAlg.Padding = PaddingMode.PKCS7;\par
\par
                ICryptoTransform decryptor = aesAlg.CreateDecryptor(aesAlg.Key, aesAlg.IV);\par
\par
                using (MemoryStream msDecrypt = new MemoryStream(cipherBytes))\par
                \{\par
                    using (CryptoStream csDecrypt = new CryptoStream(msDecrypt, decryptor, CryptoStreamMode.Read))\par
                    \{\par
                        using (StreamReader srDecrypt = new StreamReader(csDecrypt))\par
                        \{\par
                            return srDecrypt.ReadToEnd();\par
                        \}\par
                    \}\par
                \}\par
            \}\par
        \}\par
\par
        public static string Encrypt(string plainText)\par
        \{\par
            byte[] plainBytes = Encoding.UTF8.GetBytes(plainText);\par
\par
            using (Aes aesAlg = Aes.Create())\par
            \{\par
                aesAlg.Key = Encoding.UTF8.GetBytes(Key);\par
                aesAlg.IV = Encoding.UTF8.GetBytes(Iv);\par
                aesAlg.Mode = CipherMode.CBC;\par
                aesAlg.Padding = PaddingMode.PKCS7;\par
\par
                ICryptoTransform encryptor = aesAlg.CreateEncryptor(aesAlg.Key, aesAlg.IV);\par
\par
                using (MemoryStream msEncrypt = new MemoryStream())\par
                \{\par
                    using (CryptoStream csEncrypt = new CryptoStream(msEncrypt, encryptor, CryptoStreamMode.Write))\par
                    \{\par
                        csEncrypt.Write(plainBytes, 0, plainBytes.Length);\par
                        csEncrypt.FlushFinalBlock();\par
                        return Convert.ToBase64String(msEncrypt.ToArray());\par
                    \}\par
                \}\par
            \}\par
        \}\par
    \}\par
\}\par
\f0\par
En la acci\'f3n del controlador:\par
\f1 using Newtonsoft.Json;\f2  (Instalar el paq)\par
\par
\f1 [HttpGet("GetCompaniesByDocumentNumber/\{encryptedDocumentNumber\}")]\par
public async Task<IActionResult> GetCompaniesByDocumentNumber(string encryptedDocumentNumber)\par
\{\par
    try\par
    \{\par
        encryptedDocumentNumber = Uri.UnescapeDataString(encryptedDocumentNumber);\par
        // Verificar si encryptedDocumentNumber es una cadena Base64 v\f2\'e1lida\par
        byte[] encryptedBytes;\par
        try\par
        \{\par
            encryptedBytes = Convert.FromBase64String(encryptedDocumentNumber);\par
        \}\par
        catch (FormatException)\par
        \{\par
            return BadRequest("La cadena proporcionada no es una cadena Base64 v\'e1lida.");\par
        \}\par
\par
        var documentNumber = CryptoHelper.Decrypt(encryptedDocumentNumber);   \par
        documentNumber = StringHelper.EliminateFirstAndLast(documentNumber); \par
        var companies = await _unitOfWork.Companies.GetCompaniesByDocumentNumber(documentNumber);\par
\par
        if (companies == null || !companies.Any())\par
        \{\par
            return NotFound("No se encontraron compa\'f1\'edas para el n\'famero de documento proporcionado.");\par
        \}\par
\par
        var companiesJson = JsonConvert.SerializeObject(companies);\par
        var encryptedData = CryptoHelper.Encrypt(companiesJson);\par
\par
        return Ok(encryptedData);\par
    \}\par
    catch (Exception ex)\par
    \{\par
        return StatusCode(500, $"Error interno del servidor: \{ex.Message\} - StackTrace: \{ex.StackTrace\}");\par
    \}\par
\}\par
\f1\par
\f2 ////////////////////\par
\par
\b\f0 Como adicionar un par\'e1metro de salida\par
\b0 En la bd\par
ALTER PROCEDURE GetCompaniesByDocumentNumber\par
    @DocumentNumber NVARCHAR(100),\par
    @UserNotFound BIT OUTPUT\par
AS\par
BEGIN\par
    SET @UserNotFound = 0;\par
\par
    BEGIN TRY        \par
        DECLARE @IdUser INT;\par
\par
        -- Validar si el DocumentNumber existe\par
        SELECT @IdUser = IdUser \par
        FROM dbo.MT_Users \par
        WHERE DocumentNumber = @DocumentNumber;\par
        \par
        IF @IdUser IS NULL\par
        BEGIN\par
            SET @UserNotFound = 1;\par
            RETURN;\par
        END\par
\par
        -- Si existe, seleccionar las compa\'f1\'edas relacionadas\par
        SELECT c.IdCompany, \par
               c.CompanyName, \par
               c.DB, \par
               c.UserName, \par
               c.CompanyPassword, \par
               c.LicenseValidDate, \par
               c.ConnectionsSimultaneousNumber\par
        FROM dbo.MT_Companies c\par
        INNER JOIN dbo.MT_UsersCompanies uc ON c.IdCompany = uc.IdCompany\par
        WHERE uc.IdUser = @IdUser;\par
    END TRY\par
    BEGIN CATCH\par
        -- Manejo de excepciones\par
        DECLARE @ErrorMessage NVARCHAR(4000);\par
        DECLARE @ErrorSeverity INT;\par
        DECLARE @ErrorState INT;\par
\par
        SELECT \par
            @ErrorMessage = ERROR_MESSAGE(),\par
            @ErrorSeverity = ERROR_SEVERITY(),\par
            @ErrorState = ERROR_STATE();\par
\par
        RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);\par
    END CATCH\par
END;\par
\par
En CompanyRepository:\par
public async Task<(List<Company> companies, bool userNotFound)> GetCompaniesByDocumentNumber(string documentNumber)\par
\{\par
    var companies = new List<Company>();\par
    bool userNotFound = false;\par
\par
    var conn = _context.Database.GetDbConnection();\par
    try\par
    \{\par
        await conn.OpenAsync();\par
        Console.WriteLine("Database connection opened.");\par
\par
        using (var command = conn.CreateCommand())\par
        \{\par
            command.CommandText = "GetCompaniesByDocumentNumber";\par
            command.CommandType = CommandType.StoredProcedure;\par
\par
            var param = command.CreateParameter();\par
            param.ParameterName = "@DocumentNumber";\par
            param.Value = documentNumber;\par
            command.Parameters.Add(param);\par
\par
            var userNotFoundParam = command.CreateParameter();\par
            userNotFoundParam.ParameterName = "@UserNotFound";\par
            userNotFoundParam.DbType = DbType.Boolean;\par
            userNotFoundParam.Direction = ParameterDirection.Output;\par
            command.Parameters.Add(userNotFoundParam);\par
\par
            Console.WriteLine($"Executing stored procedure with DocumentNumber: \{documentNumber\}");\par
\par
            using (var reader = await command.ExecuteReaderAsync())\par
            \{\par
                while (await reader.ReadAsync())\par
                \{\par
                    companies.Add(new Company\par
                    \{\par
                        IdCompany = reader.GetInt32(0),\par
                        CompanyName = reader.GetString(1),\par
                        DB = reader.GetString(2),\par
                        UserName = reader.GetString(3),\par
                        CompanyPassword = reader.GetString(4),\par
                        LicenseValidDate = reader.GetDateTime(5),\par
                        ConnectionsSimultaneousNumber = reader.GetInt32(6)\par
                    \});\par
                \}\par
            \}\par
\par
            userNotFound = (bool)userNotFoundParam.Value;\par
        \}\par
\par
        Console.WriteLine("Stored procedure executed successfully.");\par
    \}\par
    catch (Exception ex)\par
    \{\par
        Console.WriteLine($"Error executing stored procedure: \{ex.Message\}");\par
        throw;\par
    \}\par
    finally\par
    \{\par
        await conn.CloseAsync();\par
        Console.WriteLine("Database connection closed.");\par
    \}\par
\par
    return (companies, userNotFound);\par
\}\par
\par
En el controlador:\par
[HttpGet("GetCompaniesByDocumentNumber/\{encryptedDocumentNumber\}")]\par
public async Task<IActionResult> GetCompaniesByDocumentNumber(string encryptedDocumentNumber)\par
\{\par
    try\par
    \{\par
        encryptedDocumentNumber = Uri.UnescapeDataString(encryptedDocumentNumber);\par
        // Verificar si encryptedDocumentNumber es una cadena Base64 v\'e1lida\par
        byte[] encryptedBytes;\par
        try\par
        \{\par
            encryptedBytes = Convert.FromBase64String(encryptedDocumentNumber);\par
        \}\par
        catch (FormatException)\par
        \{\par
            return BadRequest("La cadena proporcionada no es una cadena Base64 v\'e1lida.");\par
        \}\par
\par
        var documentNumber = CryptoHelper.Decrypt(encryptedDocumentNumber);   \par
        documentNumber = StringHelper.EliminateFirstAndLast(documentNumber); \par
        var (companies, userNotFound) = await _unitOfWork.Companies.GetCompaniesByDocumentNumber(documentNumber);\par
\par
        if (userNotFound)\par
        \{\par
            return NotFound("No se encontraron compa\'f1\'edas para el n\'famero de documento proporcionado.");\par
        \}\par
\par
        var companiesJson = JsonConvert.SerializeObject(companies);\par
        var encryptedData = CryptoHelper.Encrypt(companiesJson);\par
\par
        return Ok(encryptedData);\par
    \}\par
    catch (Exception ex)\par
    \{\par
        return StatusCode(500, $"Error interno del servidor: \{ex.Message\} - StackTrace: \{ex.StackTrace\}");\par
    \}\par
\}\par
\par
En ICompanyRepository\par
 Task<(List<Company> companies, bool userNotFound)> GetCompaniesByDocumentNumber(string documentNumber);\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
/////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\par
/////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\par
/////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\par
/////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\cf0\fs22\lang10\par
\cf1\fs19\lang9226 /////////////////////////////\par
\par
\par
\cf0\fs22\lang10\par
}
 